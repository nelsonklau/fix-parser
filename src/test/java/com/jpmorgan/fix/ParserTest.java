package com.jpmorgan.fix;

import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.Arguments;
import org.junit.jupiter.params.provider.MethodSource;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.function.Supplier;
import java.util.stream.Stream;

import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;
import static org.junit.jupiter.api.Assertions.assertEquals;

class ParserTest {
    private final Parser parser = new Parser();

    @ParameterizedTest
    @MethodSource("validByteArraySource")
    void testParseValidByteArray(byte[] message, Supplier<Map<Float, List<Byte>>> expected) {
        // when
        Map<Float, List<Byte>> actual = assertDoesNotThrow(() -> parser.parse(message));
        // then
        assertEquals(expected.get(), actual);
    }

    private static Stream<Arguments> validByteArraySource() {
        return Stream.of(
                // Valid scenario 1: A flatten FIX message having no repeating groups
                // Logon (A): 8=FIX.4.49=10235=A49=BuySide56=SellSide34=152=20190605-11:40:30.39298=0108=30141=Y553=Username554=Password10=104
                Arguments.of(new byte[]{0x38, 0x3d, 0x46, 0x49, 0x58, 0x2e, 0x34, 0x2e, 0x34, 0x01,
                                0x39, 0x3d, 0x31, 0x30, 0x32, 0x01,
                                0x33, 0x35, 0x3d, 0x41, 0x01,
                                0x34, 0x39, 0x3d, 0x42, 0x75, 0x79, 0x53, 0x69, 0x64, 0x65, 0x01,
                                0x35, 0x36, 0x3d, 0x53, 0x65, 0x6c, 0x6c, 0x53, 0x69, 0x64, 0x65, 0x01,
                                0x33, 0x34, 0x3d, 0x31, 0x01,
                                0x35, 0x32, 0x3d, 0x32, 0x30, 0x31, 0x39, 0x30, 0x36, 0x30, 0x35, 0x2d, 0x31, 0x31, 0x3a, 0x34, 0x30, 0x3a, 0x33, 0x30, 0x2e, 0x33, 0x39, 0x32, 0x01,
                                0x39, 0x38, 0x3d, 0x30, 0x01,
                                0x31, 0x30, 0x38, 0x3d, 0x33, 0x30, 0x01,
                                0x31, 0x34, 0x31, 0x3d, 0x59, 0x01,
                                0x35, 0x35, 0x33, 0x3d, 0x55, 0x73, 0x65, 0x72, 0x6e, 0x61, 0x6d, 0x65, 0x01,
                                0x35, 0x35, 0x34, 0x3d, 0x50, 0x61, 0x73, 0x73, 0x77, 0x6f, 0x72, 0x64, 0x01,
                                0x31, 0x30, 0x3d, 0x31, 0x30, 0x34, 0x01},
                        (Supplier<Map<Float, List<Byte>>>) () -> {
                            Map<Float, List<Byte>> expected = new HashMap<>(Map.of(
                                    8.0f, List.of((byte) 0x46, (byte) 0x49, (byte) 0x58, (byte) 0x2e, (byte) 0x34, (byte) 0x2e, (byte) 0x34),
                                    9.0f, List.of((byte) 0x31, (byte) 0x30, (byte) 0x32),
                                    35.0f, List.of((byte) 0x41),
                                    49.0f, List.of((byte) 0x42, (byte) 0x75, (byte) 0x79, (byte) 0x53, (byte) 0x69, (byte) 0x64, (byte) 0x65),
                                    56.0f, List.of((byte) 0x53, (byte) 0x65, (byte) 0x6c, (byte) 0x6c, (byte) 0x53, (byte) 0x69, (byte) 0x64, (byte) 0x65),
                                    34.0f, List.of((byte) 0x31),
                                    52.0f, List.of((byte) 0x32, (byte) 0x30, (byte) 0x31, (byte) 0x39, (byte) 0x30, (byte) 0x36, (byte) 0x30, (byte) 0x35, (byte) 0x2d, (byte) 0x31, (byte) 0x31, (byte) 0x3a, (byte) 0x34, (byte) 0x30, (byte) 0x3a, (byte) 0x33, (byte) 0x30, (byte) 0x2e, (byte) 0x33, (byte) 0x39, (byte) 0x32),
                                    98.0f, List.of((byte) 0x30),
                                    108.0f, List.of((byte) 0x33, (byte) 0x30),
                                    141.0f, List.of((byte) 0x59)
                            ));
                            expected.putAll(Map.of(
                                    553.0f, List.of((byte) 0x55, (byte) 0x73, (byte) 0x65, (byte) 0x72, (byte) 0x6e, (byte) 0x61, (byte) 0x6d, (byte) 0x65),
                                    554.0f, List.of((byte) 0x50, (byte) 0x61, (byte) 0x73, (byte) 0x73, (byte) 0x77, (byte) 0x6f, (byte) 0x72, (byte) 0x64),
                                    10.0f, List.of((byte) 0x31, (byte) 0x30, (byte) 0x34)
                            ));
                            return expected;
                        }
                ),

                // Valid scenario 2: A 2-layer FIX message having repeating groups, full group members exist
                // New Order Single (D): 8=FIX.4.49=14835=D34=108049=TESTBUY152=20180920-18:14:19.50856=TESTSELL111=63673064027889863415=USD21=238=7000854=040=154=155=MSFT48=MSFT.OQ22=5454=4455=MSFT US456=A455=US5949181045456=4455=2588173456=2455=594918104456=160=20180920-18:14:19.49210=092
                Arguments.of(new byte[]{0x38, 0x3d, 0x46, 0x49, 0x58, 0x2e, 0x34, 0x2e, 0x34, 0x01,
                                0x39, 0x3d, 0x31, 0x34, 0x38, 0x01,
                                0x33, 0x35, 0x3d, 0x44, 0x01,
                                0x33, 0x34, 0x3d, 0x31, 0x30, 0x38, 0x30, 0x01,
                                0x34, 0x39, 0x3d, 0x54, 0x45, 0x53, 0x54, 0x42, 0x55, 0x59, 0x31, 0x01,
                                0x35, 0x32, 0x3d, 0x32, 0x30, 0x31, 0x38, 0x30, 0x39, 0x32, 0x30, 0x2d, 0x31, 0x38, 0x3a, 0x31, 0x34, 0x3a, 0x31, 0x39, 0x2e, 0x35, 0x30, 0x38, 0x01,
                                0x35, 0x36, 0x3d, 0x54, 0x45, 0x53, 0x54, 0x53, 0x45, 0x4c, 0x4c, 0x31, 0x01,
                                0x31, 0x31, 0x3d, 0x36, 0x33, 0x36, 0x37, 0x33, 0x30, 0x36, 0x34, 0x30, 0x32, 0x37, 0x38, 0x38, 0x39, 0x38, 0x36, 0x33, 0x34, 0x01,
                                0x31, 0x35, 0x3d, 0x55, 0x53, 0x44, 0x01,
                                0x32, 0x31, 0x3d, 0x32, 0x01,
                                0x33, 0x38, 0x3d, 0x37, 0x30, 0x30, 0x30, 0x01,
                                0x38, 0x35, 0x34, 0x3d, 0x30, 0x01,
                                0x34, 0x30, 0x3d, 0x31, 0x01,
                                0x35, 0x34, 0x3d, 0x31, 0x01,
                                0x35, 0x35, 0x3d, 0x4d, 0x53, 0x46, 0x54, 0x01,
                                0x34, 0x38, 0x3d, 0x4d, 0x53, 0x46, 0x54, 0x2e, 0x4f, 0x51, 0x01,
                                0x32, 0x32, 0x3d, 0x35, 0x01,
                                0x34, 0x35, 0x34, 0x3d, 0x34, 0x01,
                                0x34, 0x35, 0x35, 0x3d, 0x4d, 0x53, 0x46, 0x54, 0x20, 0x55, 0x53, 0x01,
                                0x34, 0x35, 0x36, 0x3d, 0x41, 0x01,
                                0x34, 0x35, 0x35, 0x3d, 0x55, 0x53, 0x35, 0x39, 0x34, 0x39, 0x31, 0x38, 0x31, 0x30, 0x34, 0x35, 0x01,
                                0x34, 0x35, 0x36, 0x3d, 0x34, 0x01,
                                0x34, 0x35, 0x35, 0x3d, 0x32, 0x35, 0x38, 0x38, 0x31, 0x37, 0x33, 0x01,
                                0x34, 0x35, 0x36, 0x3d, 0x32, 0x01,
                                0x34, 0x35, 0x35, 0x3d, 0x35, 0x39, 0x34, 0x39, 0x31, 0x38, 0x31, 0x30, 0x34, 0x01,
                                0x34, 0x35, 0x36, 0x3d, 0x31, 0x01,
                                0x36, 0x30, 0x3d, 0x32, 0x30, 0x31, 0x38, 0x30, 0x39, 0x32, 0x30, 0x2d, 0x31, 0x38, 0x3a, 0x31, 0x34, 0x3a, 0x31, 0x39, 0x2e, 0x34, 0x39, 0x32, 0x01,
                                0x31, 0x30, 0x3d, 0x30, 0x39, 0x32, 0x01},
                        (Supplier<Map<Float, List<Byte>>>) () -> {
                            Map<Float, List<Byte>> expected = new HashMap<>(Map.of(
                                    8.0f, List.of((byte) 0x46, (byte) 0x49, (byte) 0x58, (byte) 0x2e, (byte) 0x34, (byte) 0x2e, (byte) 0x34),
                                    9.0f, List.of((byte) 0x31, (byte) 0x34, (byte) 0x38),
                                    35.0f, List.of((byte) 0x44),
                                    34.0f, List.of((byte) 0x31, (byte) 0x30, (byte) 0x38, (byte) 0x30),
                                    49.0f, List.of((byte) 0x54, (byte) 0x45, (byte) 0x53, (byte) 0x54, (byte) 0x42, (byte) 0x55, (byte) 0x59, (byte) 0x31),
                                    52.0f, List.of((byte) 0x32, (byte) 0x30, (byte) 0x31, (byte) 0x38, (byte) 0x30, (byte) 0x39, (byte) 0x32, (byte) 0x30, (byte) 0x2d, (byte) 0x31, (byte) 0x38, (byte) 0x3a, (byte) 0x31, (byte) 0x34, (byte) 0x3a, (byte) 0x31, (byte) 0x39, (byte) 0x2e, (byte) 0x35, (byte) 0x30, (byte) 0x38),
                                    56.0f, List.of((byte) 0x54, (byte) 0x45, (byte) 0x53, (byte) 0x54, (byte) 0x53, (byte) 0x45, (byte) 0x4c, (byte) 0x4c, (byte) 0x31),
                                    11.0f, List.of((byte) 0x36, (byte) 0x33, (byte) 0x36, (byte) 0x37, (byte) 0x33, (byte) 0x30, (byte) 0x36, (byte) 0x34, (byte) 0x30, (byte) 0x32, (byte) 0x37, (byte) 0x38, (byte) 0x38, (byte) 0x39, (byte) 0x38, (byte) 0x36, (byte) 0x33, (byte) 0x34),
                                    15.0f, List.of((byte) 0x55, (byte) 0x53, (byte) 0x44),
                                    21.0f, List.of((byte) 0x32)
                            ));
                            expected.putAll(Map.of(
                                    38.0f, List.of((byte) 0x37, (byte) 0x30, (byte) 0x30, (byte) 0x30),
                                    854.0f, List.of((byte) 0x30),
                                    40.0f, List.of((byte) 0x31),
                                    54.0f, List.of((byte) 0x31),
                                    55.0f, List.of((byte) 0x4d, (byte) 0x53, (byte) 0x46, (byte) 0x54),
                                    48.0f, List.of((byte) 0x4d, (byte) 0x53, (byte) 0x46, (byte) 0x54, (byte) 0x2e, (byte) 0x4f, (byte) 0x51),
                                    22.0f, List.of((byte) 0x35)
                            ));
                            expected.putAll(Map.of(
                                    454.0f, List.of((byte) 0x34),
                                    455.0f, List.of((byte) 0x4d, (byte) 0x53, (byte) 0x46, (byte) 0x54, (byte) 0x20, (byte) 0x55, (byte) 0x53),
                                    456.0f, List.of((byte) 0x41),
                                    455.1f, List.of((byte) 0x55, (byte) 0x53, (byte) 0x35, (byte) 0x39, (byte) 0x34, (byte) 0x39, (byte) 0x31, (byte) 0x38, (byte) 0x31, (byte) 0x30, (byte) 0x34, (byte) 0x35),
                                    456.1f, List.of((byte) 0x34),
                                    455.2f, List.of((byte) 0x32, (byte) 0x35, (byte) 0x38, (byte) 0x38, (byte) 0x31, (byte) 0x37, (byte) 0x33),
                                    456.2f, List.of((byte) 0x32),
                                    455.3f, List.of((byte) 0x35, (byte) 0x39, (byte) 0x34, (byte) 0x39, (byte) 0x31, (byte) 0x38, (byte) 0x31, (byte) 0x30, (byte) 0x34),
                                    456.3f, List.of((byte) 0x31)
                            ));
                            expected.putAll(Map.of(
                                    60.0f, List.of((byte) 0x32, (byte) 0x30, (byte) 0x31, (byte) 0x38, (byte) 0x30, (byte) 0x39, (byte) 0x32, (byte) 0x30, (byte) 0x2d, (byte) 0x31, (byte) 0x38, (byte) 0x3a, (byte) 0x31, (byte) 0x34, (byte) 0x3a, (byte) 0x31, (byte) 0x39, (byte) 0x2e, (byte) 0x34, (byte) 0x39, (byte) 0x32),
                                    10.0f, List.of((byte) 0x30, (byte) 0x39, (byte) 0x32)
                            ));
                            return expected;
                        }
                )
        );
    }
}